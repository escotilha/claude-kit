#!/bin/bash
set -euo pipefail

# Claude Config Sync - Syncs local Claude config with GitHub
# Repository: escotilha/claude

REPO="escotilha/claude"
TEMP_DIR="/tmp/claude-sync-$$"
LOCAL_CLAUDE="$HOME/.claude"
LOCAL_SKILLS="$HOME/.config/claude/skills"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

cleanup() {
    rm -rf "$TEMP_DIR" 2>/dev/null || true
}
trap cleanup EXIT

log_info() { echo -e "${BLUE}â„¹${NC} $1"; }
log_success() { echo -e "${GREEN}âœ“${NC} $1"; }
log_warn() { echo -e "${YELLOW}âš ${NC} $1"; }
log_error() { echo -e "${RED}âœ—${NC} $1"; }

# Check if gh is authenticated
if ! gh auth status &>/dev/null; then
    log_error "GitHub CLI not authenticated. Run: gh auth login"
    exit 1
fi

echo -e "${BLUE}Claude Config Sync${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

# Clone repo to temp
log_info "Fetching remote config from GitHub..."
mkdir -p "$TEMP_DIR"
gh repo clone "$REPO" "$TEMP_DIR/repo" -- --quiet 2>/dev/null

# Function to get checksum of a directory (excluding .git)
get_checksum() {
    local dir="$1"
    if [ -d "$dir" ]; then
        find "$dir" -type f ! -path "*/.git/*" -exec md5 -q {} \; 2>/dev/null | sort | md5 -q
    else
        echo "none"
    fi
}

# Function to get checksum of specific local paths matching repo structure
get_local_checksum() {
    local tmp_local="$TEMP_DIR/local_snapshot"
    mkdir -p "$tmp_local"

    # Copy local files matching repo structure
    [ -f "$LOCAL_CLAUDE/settings.json" ] && cp "$LOCAL_CLAUDE/settings.json" "$tmp_local/" 2>/dev/null || true
    [ -d "$LOCAL_CLAUDE/agents" ] && cp -r "$LOCAL_CLAUDE/agents" "$tmp_local/" 2>/dev/null || true
    [ -d "$LOCAL_CLAUDE/commands" ] && cp -r "$LOCAL_CLAUDE/commands" "$tmp_local/" 2>/dev/null || true
    [ -d "$LOCAL_SKILLS" ] && cp -r "$LOCAL_SKILLS" "$tmp_local/skills" 2>/dev/null || true

    get_checksum "$tmp_local"
}

# Function to get checksum of repo (relevant files only)
get_repo_checksum() {
    local tmp_repo="$TEMP_DIR/repo_snapshot"
    mkdir -p "$tmp_repo"

    [ -f "$TEMP_DIR/repo/settings.json" ] && cp "$TEMP_DIR/repo/settings.json" "$tmp_repo/" 2>/dev/null || true
    [ -d "$TEMP_DIR/repo/agents" ] && cp -r "$TEMP_DIR/repo/agents" "$tmp_repo/" 2>/dev/null || true
    [ -d "$TEMP_DIR/repo/commands" ] && cp -r "$TEMP_DIR/repo/commands" "$tmp_repo/" 2>/dev/null || true
    [ -d "$TEMP_DIR/repo/skills" ] && cp -r "$TEMP_DIR/repo/skills" "$tmp_repo/" 2>/dev/null || true

    get_checksum "$tmp_repo"
}

LOCAL_SUM=$(get_local_checksum)
REPO_SUM=$(get_repo_checksum)

log_info "Local checksum:  ${LOCAL_SUM:0:8}..."
log_info "Remote checksum: ${REPO_SUM:0:8}..."
echo ""

if [ "$LOCAL_SUM" = "$REPO_SUM" ]; then
    log_success "Already in sync! No changes needed."
    exit 0
fi

# Get modification times to determine which is newer
LOCAL_MTIME=$(find "$LOCAL_CLAUDE" "$LOCAL_SKILLS" -type f ! -path "*/.git/*" -exec stat -f %m {} \; 2>/dev/null | sort -rn | head -1 || echo "0")
REPO_MTIME=$(cd "$TEMP_DIR/repo" && git log -1 --format=%ct 2>/dev/null || echo "0")

log_info "Local last modified:  $(date -r "$LOCAL_MTIME" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "unknown")"
log_info "Remote last commit:   $(date -r "$REPO_MTIME" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "unknown")"
echo ""

# Determine sync direction
if [ "$LOCAL_MTIME" -gt "$REPO_MTIME" ]; then
    SUGGESTED="push"
    log_warn "Local config is NEWER than GitHub"
else
    SUGGESTED="pull"
    log_warn "GitHub config is NEWER than local"
fi

echo ""
echo "Options:"
echo "  [1] Pull from GitHub (overwrite local)"
echo "  [2] Push to GitHub (overwrite remote)"
echo "  [3] Show diff"
echo "  [4] Cancel"
echo ""

if [ "$SUGGESTED" = "pull" ]; then
    read -p "Choose action [1 recommended]: " -n 1 -r CHOICE
else
    read -p "Choose action [2 recommended]: " -n 1 -r CHOICE
fi
echo ""

case $CHOICE in
    1)
        echo ""
        log_info "Pulling from GitHub..."

        # Backup current config
        BACKUP_TIME=$(date +%Y%m%d_%H%M%S)
        if [ -f "$LOCAL_CLAUDE/settings.json" ]; then
            cp "$LOCAL_CLAUDE/settings.json" "$LOCAL_CLAUDE/settings.json.backup_$BACKUP_TIME"
            log_success "Backed up settings.json"
        fi

        # Copy from repo to local
        [ -f "$TEMP_DIR/repo/settings.json" ] && cp "$TEMP_DIR/repo/settings.json" "$LOCAL_CLAUDE/"
        [ -d "$TEMP_DIR/repo/agents" ] && cp -r "$TEMP_DIR/repo/agents/"* "$LOCAL_CLAUDE/agents/" 2>/dev/null || true
        [ -d "$TEMP_DIR/repo/commands" ] && cp -r "$TEMP_DIR/repo/commands/"* "$LOCAL_CLAUDE/commands/" 2>/dev/null || true
        [ -d "$TEMP_DIR/repo/skills" ] && cp -r "$TEMP_DIR/repo/skills/"* "$LOCAL_SKILLS/" 2>/dev/null || true

        log_success "Pulled config from GitHub!"
        ;;
    2)
        echo ""
        log_info "Pushing to GitHub..."

        # Copy local to repo
        [ -f "$LOCAL_CLAUDE/settings.json" ] && cp "$LOCAL_CLAUDE/settings.json" "$TEMP_DIR/repo/"
        [ -d "$LOCAL_CLAUDE/agents" ] && rm -rf "$TEMP_DIR/repo/agents" && cp -r "$LOCAL_CLAUDE/agents" "$TEMP_DIR/repo/"
        [ -d "$LOCAL_CLAUDE/commands" ] && rm -rf "$TEMP_DIR/repo/commands" && cp -r "$LOCAL_CLAUDE/commands" "$TEMP_DIR/repo/"
        [ -d "$LOCAL_SKILLS" ] && rm -rf "$TEMP_DIR/repo/skills" && cp -r "$LOCAL_SKILLS" "$TEMP_DIR/repo/skills"

        # Commit and push
        cd "$TEMP_DIR/repo"
        git add -A

        if git diff --staged --quiet; then
            log_warn "No changes to commit"
        else
            git commit -m "Sync local Claude config

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
            git push origin master
            log_success "Pushed config to GitHub!"
        fi
        ;;
    3)
        echo ""
        log_info "Showing differences..."
        echo ""

        # Compare settings.json
        if [ -f "$LOCAL_CLAUDE/settings.json" ] && [ -f "$TEMP_DIR/repo/settings.json" ]; then
            echo -e "${BLUE}=== settings.json ===${NC}"
            diff -u "$TEMP_DIR/repo/settings.json" "$LOCAL_CLAUDE/settings.json" || true
            echo ""
        fi

        # Compare agents
        echo -e "${BLUE}=== agents/ ===${NC}"
        diff -rq "$TEMP_DIR/repo/agents" "$LOCAL_CLAUDE/agents" 2>/dev/null || true
        echo ""

        # Compare skills
        echo -e "${BLUE}=== skills/ ===${NC}"
        diff -rq "$TEMP_DIR/repo/skills" "$LOCAL_SKILLS" 2>/dev/null || true
        echo ""

        # Re-run script for action
        exec "$0"
        ;;
    *)
        log_warn "Cancelled."
        exit 0
        ;;
esac
