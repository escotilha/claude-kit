#!/bin/zsh
set -euo pipefail

AGENT="${1:-}"
if [[ -z "$AGENT" ]]; then
  echo "Usage: claude-snapshot AGENT_NAME [optional-message]" >&2
  echo "" >&2
  echo "Examples:" >&2
  echo "  claude-snapshot frontend \"pre-refactor components\"" >&2
  echo "  claude-snapshot backend \"before-api-changes\"" >&2
  exit 1
fi

MSG="${2:-}"

if ! git rev-parse --show-toplevel >/dev/null 2>&1; then
  echo "âŒ Not a git repository. Initialize with: git init" >&2
  exit 1
fi

# Ensure git identity is configured
[[ -n "$(git config user.name || true)" ]] || git config user.name "Pierre Schurmann"
[[ -n "$(git config user.email || true)" ]] || git config user.email "escotilha@gmail.com"

STAMP="$(date +%F-%H%M%S)"
TAG="claude-snapshot/${AGENT}/${STAMP}"
COMMIT_MSG="[CLAUDE SNAPSHOT] agent=${AGENT} ts=${STAMP} ${MSG}"

echo "ğŸ“¸ Creating snapshot for agent: $AGENT"

# Stage and commit if there are changes
if ! git diff --quiet || ! git diff --cached --quiet; then
  git add -A
  git commit -m "$COMMIT_MSG" || true
  echo "âœ… Changes committed"
else
  echo "â„¹ï¸  No changes to commit; tagging current HEAD"
fi

# Tag current HEAD
git tag -a "$TAG" -m "$COMMIT_MSG"
echo "âœ… Snapshot created: $TAG"
echo ""
echo "ğŸ“‹ Recent changes:"
git show --stat -1
echo ""
echo "ğŸ”„ To rollback to this point later, run: claude-rollback"
