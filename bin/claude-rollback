#!/bin/zsh
set -euo pipefail

if ! git rev-parse --show-toplevel >/dev/null 2>&1; then
  echo "âŒ Not a git repository." >&2
  exit 1
fi

echo "ğŸ” Recent Claude snapshots:"
echo ""

typeset -a MAPFILE
i=1
while IFS= read -r line; do
  echo "[$i] $line"
  MAPFILE+=("$line")
  (( i++ ))
done < <(git log --grep='\[CLAUDE SNAPSHOT\]' --pretty=format:'%h %ad %s' --date=short -n 30)

if (( ${#MAPFILE[@]} == 0 )); then
  echo "â„¹ï¸  No snapshot commits found."
  echo ""
  echo "Create snapshots with: claude-snapshot AGENT_NAME \"description\""
  exit 0
fi

echo ""
print -n "ğŸ¯ Select number to rollback to (or 0 to cancel): "
read choice

if [[ "$choice" == "0" ]]; then
  echo "âŒ Cancelled."
  exit 0
fi

if ! [[ "$choice" =~ '^[0-9]+$' ]] || (( choice < 1 || choice > ${#MAPFILE[@]} )); then
  echo "âŒ Invalid selection." >&2
  exit 1
fi

TARGET_LINE="${MAPFILE[$choice]}"
TARGET_HASH="$(echo "$TARGET_LINE" | awk '{print $1}')"

echo ""
echo "âš ï¸  WARNING: This will reset your working directory to: $TARGET_LINE"
echo "   Your current changes will be stashed automatically."
echo ""
print -n "Continue? (yes/no): "
read confirm

if [[ "$confirm" != "yes" ]]; then
  echo "âŒ Cancelled."
  exit 0
fi

echo ""
echo "ğŸ“¦ Stashing current changes (if any) ..."
git stash push -u -m "pre-rollback $(date +%F-%H%M%S)" || true

echo "ğŸ”„ Resetting to $TARGET_HASH ..."
git reset --hard "$TARGET_HASH"

echo ""
echo "âœ… Rollback complete!"
echo ""
echo "ğŸ“‹ To recover your pre-rollback changes:"
echo "   git stash list"
echo "   git stash show -p stash@{0}"
echo "   git stash apply stash@{0}"
echo ""
echo "ğŸ“¸ To create a new snapshot: claude-snapshot AGENT_NAME \"description\""
