#!/bin/zsh
set -euo pipefail

CLAUDE="/opt/homebrew/bin/claude"
ALL_AGENTS=("frontend" "backend" "testing" "security" "devops" "database" "documentation" "codereview")

usage() {
  cat <<'USAGE'
ü§ñ Claude Agents - Launch multiple specialized agents concurrently

Usage:
  claude-agents /path/to/project --agents frontend,backend[,testing,security,...]
  claude-agents /path/to/project --full-stack
  claude-agents /path/to/project --preset NAME

Options:
  --agents AGENTS     Comma-separated list of agents to launch
  --full-stack        Launch frontend, backend, testing, security
  --preset NAME       Use a preset combination (see below)
  -h, --help          Show this help

Available Agents:
  frontend           React, Vue, Angular, Next.js, TypeScript, styling
  backend            Node.js, Python, APIs, databases, auth
  testing            Unit, integration, E2E tests
  security           Security reviews, vulnerability scanning
  devops             CI/CD, Docker, cloud infrastructure
  database           Schema design, migrations, optimization
  documentation      README, API docs, code comments
  codereview         PR reviews, code quality checks

Presets:
  --full-stack       frontend, backend, testing, security
  --core             frontend, backend, testing
  --docs             backend, documentation, testing
  --infra            devops, database, backend
  --review           codereview, security, testing

Examples:
  # Full-stack development (4 agents)
  claude-agents . --full-stack

  # Custom combination
  claude-agents ~/projects/app --agents frontend,backend,documentation

  # Use a preset
  claude-agents . --preset core

  # Single agent (for comparison)
  claude-agents . --agents frontend

Requirements:
  - tmux must be installed: brew install tmux
  - Agent profiles must exist in ~/.claude/agents/
  - Project must be a directory

Tmux Navigation:
  Ctrl-b + arrow keys   Navigate between panes
  Ctrl-b + x            Close current pane
  Ctrl-b + d            Detach from session (resume with: tmux attach)
  Ctrl-b + z            Zoom current pane (toggle fullscreen)
  Ctrl-b + [            Scroll mode (q to exit)

USAGE
}

# Parse args
if [[ $# -lt 1 ]] || [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

PROJECT="$1"; shift || true
[[ -d "$PROJECT" ]] || { echo "‚ùå Project directory not found: $PROJECT" >&2; exit 1; }
PROJECT="$(cd "$PROJECT" && pwd)"

AGENTS_CSV=""
while [[ $# -gt 0 ]]; do
  case "${1:-}" in
    --agents)
      AGENTS_CSV="${2:-}"
      shift 2
      ;;
    --full-stack)
      AGENTS_CSV="frontend,backend,testing,security"
      shift
      ;;
    --preset)
      PRESET="${2:-}"
      shift 2
      case "$PRESET" in
        core) AGENTS_CSV="frontend,backend,testing" ;;
        docs) AGENTS_CSV="backend,documentation,testing" ;;
        infra) AGENTS_CSV="devops,database,backend" ;;
        review) AGENTS_CSV="codereview,security,testing" ;;
        *) echo "‚ùå Unknown preset: $PRESET" >&2; exit 1 ;;
      esac
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "‚ùå Unknown option: $1" >&2
      usage
      exit 1
      ;;
  esac
done

# Default to frontend+backend if no agents specified
if [[ -z "$AGENTS_CSV" ]]; then
  AGENTS_CSV="frontend,backend"
fi

typeset -a AGENTS
AGENTS=("${(@s:,:)AGENTS_CSV}")

# Validate agent files exist
for a in "${AGENTS[@]}"; do
  if [[ ! -f "$HOME/.claude/agents/${a}-agent.md" ]]; then
    echo "‚ùå Missing agent file: $HOME/.claude/agents/${a}-agent.md" >&2
    echo "   Available agents: ${ALL_AGENTS[@]}" >&2
    exit 1
  fi
done

if ! command -v tmux >/dev/null 2>&1; then
  echo "‚ùå tmux is required. Install with: brew install tmux" >&2
  exit 1
fi

SESSION="claude-$(basename "$PROJECT")-$(date +%H%M%S)"
FIRST="${AGENTS[1]}"

echo "üöÄ Launching Claude Agents for: $(basename "$PROJECT")"
echo "   Agents: ${AGENTS_CSV}"
echo "   Project: $PROJECT"
echo ""

# Create first pane
tmux new-session -d -s "$SESSION" -n "$FIRST" -c "$PROJECT" \
  "$CLAUDE --dangerously-skip-permissions code"
sleep 1

# Function to inject agent profile and style the pane
inject_agent() {
  local pane="$1"
  local agent="$2"
  local color="$3"
  
  # Style pane border
  tmux select-pane -t "$pane" -P "fg=default,bg=default"
  
  # Load and paste agent profile
  if [[ -f "$HOME/.claude/agents/${agent}-agent.md" ]]; then
    # Copy file content to clipboard/buffer and paste into pane
    cat "$HOME/.claude/agents/${agent}-agent.md" | tmux load-buffer -
    tmux paste-buffer -t "$pane"
    # Send Enter to submit the agent profile
    sleep 0.5
    tmux send-keys -t "$pane" Enter
  fi
}

# Color mapping function
color_for() {
  case "$1" in
    frontend) echo "green" ;;
    backend) echo "blue" ;;
    testing) echo "magenta" ;;
    security) echo "red" ;;
    devops) echo "yellow" ;;
    database) echo "cyan" ;;
    documentation) echo "green" ;;
    codereview) echo "magenta" ;;
    *) echo "white" ;;
  esac
}

# Inject profile into first pane
inject_agent "$SESSION:0.0" "$FIRST" "$(color_for "$FIRST")"

# Create additional panes for remaining agents
for a in "${AGENTS[@]:1}"; do
  tmux split-window -t "$SESSION:0" -h -c "$PROJECT" \
    "$CLAUDE --dangerously-skip-permissions code"
  tmux select-layout -t "$SESSION:0" tiled
  sleep 1
  
  # Get the newest pane ID
  PANE="$(tmux list-panes -t "$SESSION:0" -F '#{pane_id}' | tail -n1)"
  inject_agent "$PANE" "$a" "$(color_for "$a")"
done

# Configure tmux session status bar
tmux set-option -t "$SESSION" status on
tmux set-option -t "$SESSION" status-left " #[bold]ü§ñ Claude Agents #[default] "
tmux set-option -t "$SESSION" status-right "üìÅ $(basename "$PROJECT") | #{pane_title}"

echo "‚úÖ Agents launched in tmux session: $SESSION"
echo ""
echo "üìñ Quick Reference:"
echo "   Ctrl-b + arrow keys   Navigate between panes"
echo "   Ctrl-b + x            Close current pane"
echo "   Ctrl-b + d            Detach (resume: tmux attach -t $SESSION)"
echo "   Ctrl-b + z            Zoom pane (fullscreen toggle)"
echo ""
echo "üìö See ~/.claude/AGENT_COORDINATION_GUIDE.md for workflows"
echo ""

# Attach to session
tmux attach -t "$SESSION"
